apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

/**
 * This is the configuration block to customize your React Native Android app.
 * By default you don't need to apply any configuration, just uncomment the lines you need.
 */
react {
    // 修復 entryFile 計算
    def nodeCommand = ["node", "-e", "require('expo/scripts/resolveAppEntry')", rootDir.getParent(), "android", "absolute"]
    try {
        def process = nodeCommand.execute(null, rootDir)
        process.waitFor()
        if (process.exitValue() == 0) {
            entryFile = file(process.text.trim())
        } else {
            entryFile = file("../../index.js")
        }
    } catch (Exception e) {
        entryFile = file("../../index.js")
    }
    
    // 修復其他路徑計算
    try {
        def reactNativePackagePath = ["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()
        reactNativeDir = new File(reactNativePackagePath).getParentFile().getAbsoluteFile()
        hermesCommand = new File(reactNativePackagePath).getParentFile().getAbsolutePath() + "/sdks/hermesc/%OS-BIN%/hermesc"
    } catch (Exception e) {
        reactNativeDir = new File("../../node_modules/react-native")
    }
    
    try {
        def codegenPackagePath = ["node", "--print", "require.resolve('@react-native/codegen/package.json', { paths: [require.resolve('react-native/package.json')] })"].execute(null, rootDir).text.trim()
        codegenDir = new File(codegenPackagePath).getParentFile().getAbsoluteFile()
    } catch (Exception e) {
        codegenDir = new File("../../node_modules/@react-native/codegen")
    }

    // 修復 CLI 文件路徑
    try {
        def cliPackagePath = ["node", "--print", "require.resolve('@expo/cli', { paths: [require.resolve('expo/package.json')] })"].execute(null, rootDir).text.trim()
        cliFile = new File(cliPackagePath)
    } catch (Exception e) {
        // 使用默認路徑
    }
    
    bundleCommand = "export:embed"

    /* Autolinking */
    autolinkLibrariesWithApp()
}

def enableProguardInReleaseBuilds = (findProperty('android.enableProguardInReleaseBuilds') ?: false).toBoolean()
def jscFlavor = 'org.webkit:android-jsc:+'

android {

    buildFeatures {
        prefab true
    }
    compileSdkVersion 35
    buildToolsVersion "35.0.0"

    repositories {
        flatDir {
            dirs 'libs' 
        }
    }
    ndkVersion = "28.0.13004108"

    buildToolsVersion rootProject.ext.buildToolsVersion
    namespace 'com.katiehuang.audiorecordermvp'
    defaultConfig {
        applicationId 'com.katiehuang.audiorecordermvp'
        minSdkVersion 24
        targetSdkVersion 35
        versionCode 128
        versionName "1.5.7"
        ndk { 
            abiFilters "arm64-v8a" 
        }

        externalNativeBuild {
            cmake {
                arguments "-DANDROID_SUPPORT_FLEXIBLE_PAGE_SIZES=ON"
            }
        }
    }
    
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        release {
            if (project.hasProperty('MYAPP_UPLOAD_STORE_FILE')) {
                storeFile file(MYAPP_UPLOAD_STORE_FILE)
                storePassword MYAPP_UPLOAD_STORE_PASSWORD
                keyAlias MYAPP_UPLOAD_KEY_ALIAS
                keyPassword MYAPP_UPLOAD_KEY_PASSWORD
            }
        }
    }
    
    bundle {
                density {
            enableSplit = true
        }
        abi {
            enableSplit = true
        }
        language {
            enableSplit = false
        }
    
        storeArchive {
            enable = false
        }
    }

    buildTypes {
        debug {
            packagingOptions {
                jniLibs {
                    useLegacyPackaging = false
                }
            }
            signingConfig signingConfigs.debug
        }
        release {
            packagingOptions {
                jniLibs {
                    useLegacyPackaging = false
                }
            }
            signingConfig signingConfigs.release  
            minifyEnabled enableProguardInReleaseBuilds
            shrinkResources enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }

    applicationVariants.all { variant ->
        variant.outputs.all { output ->
            if (outputFileName?.endsWith('.aab')) {
                // 對於AAB文件，我們需要在打包後處理
                def packageTask = tasks.findByName("package${variant.name.capitalize()}")
                if (packageTask) {
                    packageTask.doLast {
                        def aabFile = output.outputFile
                        if (aabFile.exists()) {
                            println "處理AAB文件以強制16KB對齊: ${aabFile.name}"
                            // 這裡可以添加後處理腳本
                        }
                    }
                }
            }
        }
    }
    
    packagingOptions {
        jniLibs {
            useLegacyPackaging = false 
        }
        
        // 移除 doNotStrip 來允許Gradle處理對齊
        // doNotStrip "**/*.so"  // 確保這行被註釋或刪除
        
        excludes += [
            "META-INF/**",
            "**/libandroid.so", 
            "**/liblog.so"
        ]

        pickFirsts += [
            "lib/**/libc++_shared.so",
            "lib/**/libfbjni.so",
            "lib/**/libjsi.so",
            "lib/**/libreactnative.so",
            "lib/**/libhermes.so",
            "lib/**/libappmodules.so",
            "lib/**/libavcodec.so",
            "lib/**/libavdevice.so",
            "lib/**/libavfilter.so",
            "lib/**/libavformat.so",
            "lib/**/libavutil.so",
            "lib/**/libswresample.so",
            "lib/**/libswscale.so",
            "lib/**/libgifimage.so",
            "lib/**/libhermestooling.so",
            "lib/**/libimagepipeline.so",
            "lib/**/libnative-filters.so",
            "lib/**/libnative-imagetranscoder.so",
            "lib/**/libstatic-webp.so"
        ]
    }
}

dependencies {
    implementation(name: 'ffmpeg-kit-16kb-6.0.0', ext: 'aar') {
        exclude group: 'com.arthenica', module: 'ffmpeg-kit-full'
    }
    implementation(name: 'smart-exception-common-0.2.1', ext: 'jar')
    implementation(name: 'smart-exception-java-0.2.1', ext: 'jar')

    implementation 'androidx.annotation:annotation:1.3.0'  
   
    def isGifEnabled = (findProperty('expo.gif.enabled') ?: "") == "true";
    def isWebpEnabled = (findProperty('expo.webp.enabled') ?: "") == "true";
    def isWebpAnimatedEnabled = (findProperty('expo.webp.animated') ?: "") == "true";

    if (isGifEnabled) {
        implementation("com.facebook.fresco:animated-gif:${reactAndroidLibs.versions.fresco.get()}")
    }

    if (isWebpEnabled) {
        implementation("com.facebook.fresco:webpsupport:${reactAndroidLibs.versions.fresco.get()}")
        if (isWebpAnimatedEnabled) {
            implementation("com.facebook.fresco:animated-webp:${reactAndroidLibs.versions.fresco.get()}")
        }
    }

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
}